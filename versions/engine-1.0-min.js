function Point(e,i){this.x=e,this.y=i,this.set=function(e,i){this.setX(e),this.setY(i)},this.setX=function(e){this.x=e},this.setY=function(e){this.y=e},this.getX=function(){return this.x},this.getY=function(){return this.y},this.add=function(e){this.x+=e.x,this.y+=e.y},this.subtract=function(e){this.x-=e.x,this.y-=e.y},this.multiply=function(e){this.x*=e.x,this.y*=e.y},this.divide=function(e){this.x/=e.x,this.y/=e.y}}function Dimension(e,i){this.width=e,this.height=i,this.set=function(e,i){this.setWidth(e),this.setHeight(i)},this.setWidth=function(e){this.width=e},this.setHeight=function(e){this.height=e},this.getWidth=function(){return this.width},this.getHeight=function(){return this.height},this.add=function(e){this.width+=e.width,this.height+=e.height},this.subtract=function(e){this.width-=e.width,this.height-=e.height},this.scale=function(e){this.width*=e,this.height*=e}}function Vector(e,i){this.x=e,this.y=i,this.set=function(e,i){this.setX(e),this.setY(i)},this.setX=function(e){this.x=e},this.setY=function(e){this.y=e},this.getX=function(){return this.x},this.getY=function(){return this.y},this.add=function(e){this.x+=e.x,this.y+=e.y},this.subtract=function(e){this.x-=e.x,this.y-=e.y},this.multiply=function(e){this.x*=e.x,this.y*=e.y},this.divide=function(e){this.x/=e.x,this.y/=e.y},this.getAngle=function(){return engine.math.getAngle(0,0,this.getX(),this.getY())},this.getDistance=function(){return Math.sqrt((0-this.getX())*(0-this.getX())+(0-this.getY())*(0-this.getY()))},this.rotate=function(e){var i=this.getDistance(),t=this.getAngle()+e;this.x=Math.cos(t*Math.PI/180)*i,this.y=Math.sin(t*Math.PI/180)*i},this.flip=function(){this.rotate(180)},this.scale=function(e){this.multiply(new Vector(e,e))}}function resize(){engine.fullscreen&&(MAX_WIDTH=$(window).width(),MAX_HEIGHT=$(window).height()),engine.width=$(window).width(),engine.height=$(window).height(),engine.scene.style.top=0,engine.width>MAX_WIDTH?(engine.width=MAX_WIDTH,engine.scene.style.left=$(window).width()/2-MAX_WIDTH/2):engine.scene.style.left=0,engine.height>MAX_HEIGHT?(engine.height=MAX_HEIGHT,engine.scene.style.top=$(window).height()/2-MAX_HEIGHT/1.6,null!=engine.desc&&(engine.desc.style.top=$(window).height()/2+MAX_HEIGHT/2.4),showDesc=!0):showDesc=!1,showDesc?null!=engine.desc&&(engine.desc.style.display="block"):null!=engine.desc&&(engine.desc.style.display="none"),engine.scene.width=engine.width,engine.scene.height=engine.height,engine.context=engine.scene.getContext("2d"),engine.context.ImageSmoothingEnabled=engine.context.imageSmoothingEnabled=engine.context.mozImageSmoothingEnabled=engine.context.oImageSmoothingEnabled=!1}function Sprite(e,i,t,n,s,h){this.name=e,this.x=i,this.y=t,this.width=n,this.height=s,this.image=h}function Animation(e,i,t,n,s,h,g){this.name=e,this.image=i.image,this.spriteWidth=t,this.spriteHeight=n,this.fps=s,this.play=!1,this.loop=h,this.currentFrame=0,this.framesWide=this.image.width/this.spriteWidth,this.framesHigh=this.image.height/this.spriteHeight,this.numFrames=void 0!=g&&null!=g&&0!=g?g:this.framesWide*this.framesHigh,this.timer=0,this.start=function(){this.play=!0},this.stop=function(){this.play=!1},this.update=function(){this.play&&this.timer++,this.timer>=60/this.fps&&(this.currentFrame++,this.currentFrame>=this.numFrames&&(this.currentFrame=0),this.timer=0)},this.draw=function(e,i,t,n,s){var h=this.spriteWidth*Math.round(this.currentFrame%this.framesWide),g=this.spriteHeight*Math.floor(this.currentFrame/this.framesHigh);s?(engine.context.save(),engine.context.translate(engine.width,0),engine.context.scale(-1,1),engine.context.translate(-e*engine.getScale()+2*engine.camera.position.getX(),i*engine.getScale()),engine.drawImage(this.image,h,g,this.spriteWidth,this.spriteHeight,0,0,t,n),engine.context.restore()):engine.drawImage(this.image,h,g,this.spriteWidth,this.spriteHeight,e,i,t,n)}}function ImageObject(e,i){this.name=e,this.image=i}function initImages(){var e=engine.imagePaths;requiredImages=e.length;for(i in e){var t=new Image;t.src=e[i][1],engine.images[i]=new ImageObject(e[i][0],t),engine.images[i].image.onload=function(){doneImages++}}}function checkImages(){doneImages>=requiredImages?engine.init():setTimeout(function(){checkImages()},1)}function Camera(e,i,t,n){this.x=e,this.y=i,this.width=t,this.height=n,this.ws=1,this.hs=1,this.getViewportWidth=function(){return this.width},this.getViewportHeight=function(){return this.height},this.resize=function(){this.ws=engine.width/this.width,this.hs=engine.height/this.height,console.log(this.ws+", "+this.hs+", "+engine.width/this.width)},engine.drawImage=function(e,i,t,n,s,h,g,o,c){c*=this.hs,engine.context.drawImage(e,i,t,n,s,h-o/2,g-c/2,1*o,c)}}function CollisionBox(e,i,t,n,s){this.position=new Point(i,t),this.size=new Dimension(n,s),this.name=e,this.velocity=new Vector(0,0),this.intersects=function(e){return this.position.getY()+this.size.getHeight()/2>=e.position.getY()-e.size.getHeight()/2&&this.position.getX()-this.size.getWidth()/2<=e.position.getX()+e.size.getWidth()/2&&this.position.getY()-this.size.getHeight()/2<=e.position.getY()+e.size.getHeight()/2&&this.position.getX()+this.size.getWidth()/2>=e.position.getX()-e.size.getWidth()/2?!0:!1},this.applyForce=function(e){this.velocity.add(e)},this.update=function(){this.position.add(new Point(this.velocity.getX(),this.velocity.getY()))}}function World(){this.objects=[],this.addObject=function(e){this.objects.push(e)},this.getObject=function(e){for(var i=0;i<this.objects.length;i++)if(null!=this.objects[i]&&this.objects[i].name==e)return this.objects[i];return null},this.getObjectByIndex=function(e){return this.objects[e]},this.update=function(){for(var e=0;e<this.objects.length&&!(e>=this.objects.length);e++)if(null!=this.objects[e]){for(var i=this.objects[e],t=!1,n=0;n<Math.abs(i.velocity.getY());n++){for(var s=new CollisionBox("tmp",i.position.getX(),i.position.getY()+Math.abs(i.velocity.getY())/-i.velocity.getY(),i.size.getWidth(),i.size.getHeight()),h=0;h<this.objects.length&&!(h>=this.objects.length);h++)if(null!=this.objects[h]&&this.objects[h]!=i){var g=this.objects[h];if(s.intersects(g)){t=!0,i.velocity.setY(0);break}}t||(i.position.y+=Math.abs(i.velocity.getY())/-i.velocity.getY())}for(var o=!1,n=0;n<Math.abs(i.velocity.getX());n++){for(var s=new CollisionBox("tmp",i.position.getX()-Math.abs(i.velocity.getX())/-i.velocity.getX(),i.position.getY(),i.size.getWidth(),i.size.getHeight()),h=0;h<this.objects.length&&!(h>=this.objects.length);h++)if(null!=this.objects[h]&&this.objects[h]!=i){var g=this.objects[h];if(s.intersects(g)){o=!0,i.velocity.setX(0);break}}o||(i.position.x-=Math.abs(i.velocity.getX())/-i.velocity.getX())}}}}var engine={};engine.mx=0,engine.my=0,engine.mb=!1,engine.keys=[],engine.scale=1,engine.setScale=function(e){engine.scale=e},engine.getScale=function(){return engine.scale};var MAX_WIDTH=800,MAX_HEIGHT=600;engine.width=$(window).width(),engine.height=$(window).height();var showDesc=!0;engine.scene=null,engine.fullscreen=!1,engine.setFullscreen=function(e){engine.fullscreen=e,e&&(MAX_WIDTH=$(window).width(),MAX_HEIGHT=$(window).height())},engine.loadScene=function(e){function i(e,i){var t=e.getBoundingClientRect();return{x:i.clientX-t.left,y:i.clientY-t.top}}console.log("Loaded scene: "+e),engine.scene=document.getElementById(e),engine.scene.style.position="absolute",window.onresize();engine.scene.getBoundingClientRect();engine.scene.addEventListener("mousemove",function(e){var t=i(engine.scene,e);engine.mx=t.x,engine.my=t.y},!1),engine.scene.onmousedown=function(){engine.mb=!0},engine.scene.onmouseup=function(){engine.mb=!1},engine.scene.onmouseleave=function(){engine.mb=!1}},engine.loadDescription=function(){engine.desc=document.getElementById("desc"),null!=engine.desc&&(engine.desc.style.position="relative",engine.desc.style.textAlign="center")},engine.camera={},engine.camera.position=new Point(0,0),engine.drawImage=function(e,i,t,n,s,h,g,o,c){engine.context.drawImage(e,i,t,n,s,(h-o/2)*engine.getScale()+engine.width/2-engine.camera.position.getX(),(g-c/2)*engine.getScale()+engine.height/2-engine.camera.position.getY(),o*engine.getScale(),c*engine.getScale())},window.onresize=function(){resize()},$(document).keydown(function(e){engine.keys[e.keyCode?e.keyCode:e.whitch]=!0}),$(document).keyup(function(e){delete engine.keys[e.keyCode?e.keyCode:e.whitch]}),engine.init=function(){console.log("Init"),engine.loop()},engine.start=function(){initImages(),checkImages(),resize()},engine.loop=function(){requestAnimFrame(function(){engine.loop()}),engine.context.lineWidth=engine.getScale(),engine.updateAnimations(),engine.render()},engine.render=function(){},window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}(),engine.math={},engine.math.getAngle=function(e,i,t,n){var s=180*Math.atan2(n-i,t-e)/Math.PI;return 0>s&&(s+=360),s>360&&(s-=360),s},engine.math.getDistance=function(e,i,t,n){return Math.sqrt((e-t)*(e-t)+(i-n)*(i-n))},engine.drawSprite=function(e,i,t,n,s){var h;h=e instanceof Sprite?e:engine.getSprite(e),engine.drawImage(h.image.image,h.x,h.y,h.width,h.height,i,t,n,s)},engine.sprites=[],engine.addSprite=function(e){engine.sprites.push(e)},engine.getSprite=function(e){for(var i=0;i<engine.sprites.length;i++)if(null!=engine.sprites[i]&&engine.sprites[i].name==e)return engine.sprites[i];return null},engine.animations=[],engine.addAnimation=function(e){engine.animations.push(e)},engine.getAnimation=function(e){for(var i=0;i<engine.animations.length;i++)if(null!=engine.animations[i]&&engine.animations[i].name==e)return engine.animations[i];return null},engine.updateAnimations=function(){for(var e=0;e<engine.animations.length&&!(e>=engine.animations.length);e++){var i=engine.animations[e];null!=i&&i.update()}},engine.images=[],engine.imagePaths=[],engine.loadImage=function(e,i){engine.imagePaths.push([e,i])},engine.getImage=function(e){for(var i=0;i<engine.images.length;i++)if(engine.images[i].name==e)return engine.images[i];return null};var doneImages=0,requiredImages=0;engine.graphics={},engine.graphics.setColor=function(e){engine.context.strokeStyle=e,engine.context.fillStyle=e},engine.graphics.drawRect=function(e,i,t,n){engine.context.strokeRect((e-t/2)*engine.getScale()+engine.width/2-engine.camera.position.getX(),(i-n/2)*engine.getScale()+engine.height/2-engine.camera.position.getY(),t*engine.getScale(),n*engine.getScale())},engine.graphics.fillRect=function(e,i,t,n){engine.context.fillRect((e-t/2)*engine.getScale()+engine.width/2-engine.camera.position.getX(),(i-n/2)*engine.getScale()+engine.height/2-engine.camera.position.getY(),t*engine.getScale(),n*engine.getScale())};